# PACK_11_BUILD_MODE.yaml

meta:
  owner: "AI Opener"
  version: "2.0.0"
  last_updated: "2025-12-29"
  purpose: "Unlocks Build-mode wizard via #build"
  notes: "INTERNAL KEY -- delete this file to disable Build-mode instantly."
  tags: [packs, build-mode]
  portability: "portable"

# Auto-inherited: base_dependencies per LOGIC_00_INDEX#auto_inheritance

# PACK-specific references
evidence_tiers: "$ref: LOGIC_08_QUALITY_GATES#evidence_tiers"
source_reliability: "$ref: LOGIC_08_QUALITY_GATES#source_reliability"
evidence_schema: "$ref: LOGIC_08_QUALITY_GATES#evidence_item_schema"
rag_integration: "$ref: LOGIC_05_RAG_MECHANICS#vector_store"

pack_definition:
  id: "PACK_11_BUILD_MODE"
  type: "capability"
  name: "Build Mode Pack"
  domain: "RAC Administration / Authoring"
  description: |
    Hidden-key pack that enables Build-mode only when a super-admin manually types `#build`.

    - No admin detection. No PIN. No background activation.
    - Create-only: outputs are NEW YAML files or NEW docs for human review.
    - If this file is removed from the vault, Build-mode disappears immediately.

knowledge_assets:
  frameworks:
    - id: "bm_non_negotiables"
      name: "Build-mode Non-Negotiables"
      description: "Hard rules the builder must follow."
      content: |
        1) Build-mode is reachable only after the user types: #build
        2) Build-mode is available only when PACK_11_BUILD_MODE.yaml exists in the vault.
        3) Create-only outputs:
           - Never edit-in-place
           - Never overwrite an existing file
           - Always emit a NEW filename for review and manual installation
        4) Output layer whitelist (allowed to generate vault-ready YAML):
           - ROLES, PACKS, LIBRARIES, USE_CASES, WORKFLOWS, ORG, CLIENT
        5) Forbidden for vault outputs:
           - CONFIG, DEMO, LOGIC, OPS
        6) If asked to change core layers (CONFIG/DEMO/LOGIC/OPS):
           - You MAY provide a NON-VAULT patch suggestion (diff/snippet) for a human to apply
           - You MUST clearly label it: "NON-VAULT PATCH (manual apply)"
        7) No inbound dependencies:
           - No non-builder SSOT file may reference this pack or its embedded assets.
        8) Deletion invariance:
           - Deleting this pack disables Build-mode, but previously created assets remain.

    - id: "bm_portability_principles"
      name: "Portability Principles"
      description: "How to author assets so they can be reused across RAC instances."
      content: |
        Goal: maximize plug & play across different client instances.

        - Prefer capability-based composition:
          * Use existing ROLE capabilities whenever possible
          * If a capability truly doesn't exist, output a NEW ROLE file rather than hacking it into a USE_CASE

        - Keep tenant-specific canon out of portable artifacts:
          * Client-specific voice, offers, claims -> CLIENT layer
          * Org defaults/process -> ORG layer
          * Private corpora -> LIBRARIES (docs live there; ORG/CLIENT only point to library_id)

        - Use $ref for shared SSOT:
          * evidence tiers, quality gates, HITL triggers, tool routing refs should point to LOGIC
          * voice defaults should point to OPS_02_VOICES_LIBRARY where applicable

        - Always publish dependencies OUTSIDE the YAML:
          * Put dependency lists in INSTALL_NOTES + in an install manifest
          * Do not add new top-level keys unless the target layer schema already includes them.

    - id: "bm_schema_detection"
      name: "Schema Detection"
      description: "How builder decides which schema to output in a given vault."
      content: |
        Before generating any vault-ready YAML:

        1) Locate an existing implementation file in the target layer (preferred):
           - USE_CASES: find any USE_CASE_{NN}_*.yaml other than USE_CASE_00_BASE_TEMPLATE.yaml
           - WORKFLOWS: find any WORKFLOW_{NN}_*.yaml other than WORKFLOW_00_BASE_TEMPLATE.yaml
           - CLIENT: use CLIENT_{client_id}.yaml structure
           - LIBRARIES: use LIBRARY_MANIFEST.yaml contract (06_LIBRARIES blueprint)

        2) If no implementation exists:
           - Use the relevant layer blueprint's canonical structure
             (07_USE_CASES, 08_WORKFLOWS, 10_CLIENT, 06_LIBRARIES).

        3) Never invent new top-level keys if the vault already has a canonical pattern.

  templates:
    - id: "bm_wizard_ui_copy"
      name: "Wizard UI Copy"
      format: "markdown"
      content: |
        BUILD-MODE (manual)
        Reply with the number only.

        1) Build new use case
        2) Build new workflow
        3) Assist onboarding (ORG/CLIENT drafts + library checklist)
        4) Update existing use case/workflow (create new version file; never overwrite)
        5) Export release bundle (install manifest + dependency/gap report)
        6) Exit

    - id: "bm_install_manifest_template"
      name: "Install Manifest Template"
      format: "yaml"
      content: |
        manifest:
          bundle_name: "<string>"
          created_at: "<YYYY-MM-DD>"
          created_by: "PACK_11_BUILD_MODE"
          target_scope: "ORG | CLIENT"
          files:
            - filename: "<SSOT filename>"
              layer: "<ROLES|PACKS|LIBRARIES|USE_CASES|WORKFLOWS|ORG|CLIENT>"
              id: "<optional: PACK_.. / USE_CASE_.. / WORKFLOW_.. / ROLE_.. / LIB_.. / CLIENT_..>"
              purpose: "<one line>"
              dependencies:
                roles: []
                packs: []
                ops_refs: []
                libraries:
                  required: false
                  required_tags: []
                  required_doc_types: []
          gap_report:
            missing_roles: []
            missing_packs: []
            missing_ops_refs: []
            missing_libraries:
              required_tags: []
              required_doc_types: []
            notes: []

  terminology:
    build_mode: "Manual authoring mode triggered by #build when PACK_11_BUILD_MODE.yaml is present."
    wizard: "Numbered menu that routes to builder flows."
    create_only: "Builder generates new files only; no overwrites, no in-place edits."
    vault_ready: "YAML intended to be copied into the SSOT vault as a new source."
    non_vault_patch: "A suggested diff/snippet for humans; not intended to be stored as SSOT."

evidence_vault:
  schema: "$ref: LOGIC_08_QUALITY_GATES#evidence_item_schema"
  items: []

capability_extensions:
  enhances_roles: []

rag_configuration:
  vector_store: "$ref: LOGIC_05_RAG_MECHANICS#vector_store"
  chunking: "$ref: LOGIC_05_RAG_MECHANICS#chunking"
  indexing:
    namespace: "{org_id}_PACK_11_BUILD_MODE"
    chunk_strategy: "$ref: LOGIC_05_RAG_MECHANICS#chunking.by_content_type.pack_frameworks"
  retrieval:
    default_top_k: 5
    filter_by_pack: true
    boost_evidence_vault: 1.0

quality_requirements:
  evidence_minimum:
    quantitative_claims: "tier_3"
    qualitative_claims: "tier_3"
  freshness:
    statistics: "No requirements"
    frameworks: "No expiry"
  validation:
    on_load:
      - "meta.portability must be present"
      - "pack_definition.id must be PACK_11_BUILD_MODE"
      - "knowledge_assets must include build-mode wizard spec"
      - "No other SSOT file may depend on this pack (operational rule)"

# ═══════════════════════════════════════════════════════════════════════════
# BUILD MODE (COMMAND-ONLY)
# ═══════════════════════════════════════════════════════════════════════════

build_mode:
  trigger_command: "#build"

  gating:
    availability_rule: "Available only when PACK_11_BUILD_MODE.yaml exists in the vault."
    no_admin_detection: true
    no_pin: true
    reachability_rule: "Builder assets are used only when trigger_command is invoked."

  session_contract:
    entry_behavior: "Render wizard menu immediately."
    selection_input: "integer 1-6"
    invalid_selection_behavior: "Re-render wizard menu + ask for number again."
    after_action_behavior: "Return to wizard menu."
    exit_behavior: "Confirm exit and stop build-mode."

  output_rules:
    create_only: true
    never_overwrite: true
    allowed_layers_for_vault_outputs: ["ROLES", "PACKS", "LIBRARIES", "USE_CASES", "WORKFLOWS", "ORG", "CLIENT"]
    forbidden_layers_for_vault_outputs: ["CONFIG", "DEMO", "LOGIC", "OPS"]

    formatting_enforcement:
      vault_outputs:
        must_be_in_code_blocks: true
        code_block_language: "yaml"
        one_file_per_code_block: true
        filename_required_in_comment: true
        refusal_on_violation: true

    required_chat_sections_for_every_builder_run:
      - "FILE_OUTPUTS (vault-ready YAML/doc blocks)"
      - "INSTALL_NOTES (what to paste where; any manual deletion steps)"
      - "DEPENDENCIES (roles/packs/ops-refs/libraries)"
      - "GAP_REPORT (only if something is missing)"

    provenance_marking:
      rule: "Mark provenance only inside existing schema fields (prefer meta.notes)."
      recommended_append_to_meta_notes: "generated_by: PACK_11_BUILD_MODE"

  wizard:
    title: "BUILD-MODE"
    instructions: "Reply with the number only."
    menu_options:
      - number: 1
        label: "Build new use case"
        handler_id: "build_new_use_case"
      - number: 2
        label: "Build new workflow"
        handler_id: "build_new_workflow"
      - number: 3
        label: "Assist onboarding (ORG/CLIENT drafts + library checklist)"
        handler_id: "assist_onboarding"
      - number: 4
        label: "Update existing use case/workflow (create new version file; never overwrite)"
        handler_id: "update_existing"
      - number: 5
        label: "Export release bundle (install manifest + dependency/gap report)"
        handler_id: "export_release_bundle"
      - number: 6
        label: "Exit"
        handler_id: "exit"

  builders:
    build_new_use_case:
      mission: "Create a new USE_CASE YAML (+ optional ROLE/PACK additions) from a plain-language description."
      hitl_checkpoints: ["Intake", "Diagnostics", "Draft", "Review", "Finalize", "Export"]
      steps:
        - step: "Intake"
          do: |
            Ask for:
            - Desired USE_CASE name + one-sentence mission
            - Who uses it (internal team vs client-facing)
            - Inputs available (brief, links, documents, brand canon, etc.)
            - Outputs expected (deliverables)
            - Sensitivity (PII? regulated? brand claims?)
            - Preferred mode (SOM/SAM/Wizard)
            - Portability target: (A) portable across instances (B) only this instance
        - step: "Cross-reference"
          do: |
            In the current vault, locate:
            - Similar USE_CASEs (by overlap)
            - Candidate ROLES whose primary capabilities match the request
            - Candidate PACKS relevant to the domain (portable only; no tenant corpora)
            - LIBRARIES availability (manifests) for this scope (discover-or-gap contract)
        - step: "Diagnostics"
          do: |
            If unclear, ask multiple-choice:
            - Primary job: (A) generate (B) analyze (C) plan (D) QA/review (E) mixed
            - Output formats: (A) markdown (B) docx (C) pptx (D) yaml (E) mixed
            - Library need: (A) required (B) optional (C) forbidden
        - step: "Draft"
          do: |
            Produce a new USE_CASE YAML draft that:
            - Mirrors the vault's existing USE_CASE schema (bm_schema_detection)
            - Uses ROLE capabilities only (no invented capabilities)
            - Uses packs only if needed
            - Declares library selection intent per the vault schema (auto/manual/required)
            - Includes quality gates via refs to LOGIC_08 universal gates (+ use_case_additions)
        - step: "Review"
          do: |
            Validate:
            - ID naming convention (USE_CASE_{NN}_{NAME})
            - At least one ROLE is weight=primary
            - Each capabilities_used item exactly matches referenced ROLE.capabilities.primary
            - Tags conform to LOGIC_03_TAXONOMY
            - No vault outputs for CONFIG/DEMO/LOGIC/OPS
        - step: "Finalize"
          do: |
            Emit required chat sections:
            FILE_OUTPUTS, INSTALL_NOTES, DEPENDENCIES, GAP_REPORT (if any).
        - step: "Export"
          do: |
            Emit install manifest + portability notes.

    build_new_workflow:
      mission: "Create a new WORKFLOW YAML with phases, gates, handoffs, and a library discovery phase."
      hitl_checkpoints: ["Intake", "Diagnostics", "Draft", "Review", "Finalize", "Export"]
      steps:
        - step: "Intake"
          do: |
            Ask for:
            - Workflow name + mission
            - Trigger/event (when it runs)
            - Final deliverables
            - Risk level: minimal/limited/high
            - Which USE_CASE(s) it should invoke (if known)
            - Scope: (A) ORG scope (B) CLIENT scope (requires runtime.client_id)
        - step: "Cross-reference"
          do: |
            Locate:
            - Similar workflows
            - Candidate USE_CASE IDs to invoke
            - Handoff contract refs (OPS_18 / OPS_19; read-only)
            - Libraries needed (required tags/doc_types)
        - step: "Diagnostics"
          do: |
            If phases unclear, propose default:
            0) Discover Libraries (required)
            1) Intake / Context Capture
            2) Execution (invoke use case(s))
            3) QA / Review + Policy gates
            4) Delivery + Handoff
        - step: "Draft"
          do: |
            Produce a new WORKFLOW YAML that:
            - Mirrors the vault's existing WORKFLOW schema (bm_schema_detection)
            - Includes a Discover Libraries phase (per 08_WORKFLOWS blueprint)
            - Uses policy_checks refs to LOGIC_16_POLICY_CAPTURE enforcement actions
            - Uses invoke_use_case actions if invoking use cases
        - step: "Review"
          do: |
            Validate:
            - Naming convention (WORKFLOW_{NN}_{NAME})
            - No circular phases; last phase handoff.to == complete
            - Every phase has entry_gate + exit_gate + policy_checks (min 1)
            - Tool invocations (if any) reference LOGIC_10 tool IDs or capability keys (no free-text)
        - step: "Finalize"
          do: |
            Emit required chat sections.
        - step: "Export"
          do: |
            Emit install manifest + portability notes.

    assist_onboarding:
      mission: "Draft CLIENT YAML and library onboarding plan; optionally draft ORG Phase I gaps."
      hitl_checkpoints: ["Intake", "Diagnostics", "Draft", "Review", "Finalize"]
      steps:
        - step: "Intake"
          do: |
            Ask for:
            - client_id + client_name
            - tier (starter/professional/enterprise)
            - industry + key offers
            - voice/tone preferences (or pick from OPS_02 voices)
            - stakeholders (approver + contact)
            - deliverable preferences (formats, length)
            - what private materials exist to onboard into LIBRARIES
        - step: "Diagnostics"
          do: |
            Determine:
            - Engagement mode: (A) agency_tenant (B) in_house_unit
            - Required libraries (rfps, past deliverables, policies, brand/legal, etc.)
            - Sensitivity per library (internal/confidential/restricted)
        - step: "Draft"
          do: |
            Produce:
            - CLIENT_{client_id}.yaml (vault-ready)
            - Library discovery outcome:
              * A) selected_library_ids + rationale OR
              * B) library_gap_report + onboarding_recommendation + suggested LIBRARY_MANIFEST stub(s)
        - step: "Review"
          do: |
            Validate:
            - CLIENT contains pointers only (no corpora embedded)
            - Library manifests follow 06_LIBRARIES blueprint
        - step: "Finalize"
          do: |
            Emit required chat sections.

    update_existing:
      mission: "Create a new version of an existing USE_CASE or WORKFLOW without overwriting the original."
      hitl_checkpoints: ["Intake", "Diagnostics", "Draft", "Review", "Finalize", "Export"]
      steps:
        - step: "Intake"
          do: |
            Ask for:
            - Target type: (1) USE_CASE (2) WORKFLOW
            - Target ID (exact)
            - Change type: (A) patch fix (B) minor feature (C) major/breaking
            - Summary of desired improvements
        - step: "Cross-reference"
          do: |
            Retrieve the existing YAML and:
            - Identify current dependencies
            - Identify schema/validation risks
        - step: "Draft"
          do: |
            Produce a NEW file (do not overwrite).
            - Keep the same ID by default
            - Bump meta.version per semver
            - Update meta.last_updated
            - Append to meta.notes: "supersedes: <old filename or version>"
        - step: "Review"
          do: |
            Validate:
            - No forbidden layer outputs
            - Naming convention holds
            - All $ref targets exist
        - step: "Finalize"
          do: |
            Emit required chat sections, including manual step:
            - Remove/archive the superseded file to avoid duplicate IDs.
        - step: "Export"
          do: |
            Emit updated install manifest + delta notes.

    export_release_bundle:
      mission: "Produce an install manifest + dependency/gap report for a set of created assets."
      hitl_checkpoints: ["Intake", "Draft", "Review", "Finalize"]
      steps:
        - step: "Intake"
          do: |
            Ask for:
            - Which files to bundle (filenames or IDs)
            - Target scope (ORG-only vs CLIENT-specific)
        - step: "Draft"
          do: |
            Produce:
            - Bundle manifest (bm_install_manifest_template)
            - Dependency list + gap report for target instance
            - Porting instructions (what must be manually created if missing)
        - step: "Review"
          do: |
            Ensure missing dependencies are explicitly listed.
        - step: "Finalize"
          do: |
            Output the manifest + porting notes.

    exit:
      mission: "Exit build-mode."
      steps:
        - step: "Exit"
          do: "Confirm exit. Stop wizard loop."
