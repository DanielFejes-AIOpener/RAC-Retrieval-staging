# LOGIC_11_TRACE.yaml

meta:
  owner: "AI Opener"
  version: "2.0.0"
  last_updated: "2025-12-11"
  purpose: "Audit trail patterns, logging, and trace reconstruction (SSOT)"
  notes: "v2.0 - Complete trace schema with retention and sampling"
  tags: [logic, trace, audit, logging, ssot]

trace_events:
  events:
    session_start:
      required_fields: [session_id, timestamp, client_id, org_id]
      optional_fields: [user_id, initial_context]
    session_end:
      required_fields: [session_id, timestamp, duration_ms, status]
      optional_fields: [summary, error]
    request_received:
      required_fields: [correlation_id, timestamp, request_type]
      optional_fields: [request_hash, intent_classification]
    response_sent:
      required_fields: [correlation_id, timestamp, response_type, duration_ms]
      optional_fields: [response_size, quality_score]
    role_activated:
      required_fields: [correlation_id, timestamp, role_id]
      optional_fields: [context_loaded, capabilities]
    use_case_started:
      required_fields: [correlation_id, timestamp, use_case_id]
      optional_fields: [parameters, mode]
    use_case_completed:
      required_fields: [correlation_id, timestamp, use_case_id, status, duration_ms]
      optional_fields: [deliverables, quality_score]
    workflow_phase_entered:
      required_fields: [correlation_id, timestamp, workflow_id, phase_id]
      optional_fields: [entry_conditions_met]
    workflow_phase_exited:
      required_fields: [correlation_id, timestamp, workflow_id, phase_id, status]
      optional_fields: [exit_conditions_met, deliverables]
    handoff:
      required_fields: [correlation_id, timestamp, from_actor, to_actor, handoff_type]
      optional_fields: [payload_summary, validation_status]
    tool_call:
      required_fields: [correlation_id, timestamp, tool_id, status, duration_ms]
      optional_fields: [input_hash, output_size, retry_count]
    hitl_triggered:
      required_fields: [correlation_id, timestamp, trigger_type, reason]
      optional_fields: [options_presented, escalation_level]
    hitl_resolved:
      required_fields: [correlation_id, timestamp, resolution, resolved_by, resolution_time_ms]
      optional_fields: [feedback]
    quality_gate_checked:
      required_fields: [correlation_id, timestamp, gate_type, gate_id, result]
      optional_fields: [checks_passed, checks_failed, details]
    evidence_used:
      required_fields: [correlation_id, timestamp, evidence_id, tier, reliability]
      optional_fields: [claim_supported, freshness_check]
    error_occurred:
      required_fields: [correlation_id, timestamp, error_code, severity]
      optional_fields: [error_message, stack_trace, recovery_action]
    checkpoint_created:
      required_fields: [correlation_id, timestamp, checkpoint_id, workflow_id]
      optional_fields: [state_hash, size_bytes]

trace_schema:
  required_fields:
    correlation_id: { type: "string", format: "uuid-v4" }
    timestamp: { type: "string", format: "ISO-8601" }
    event_type: { type: "string", enum: "$ref: #trace_events.events" }
    layer: { type: "string" }
    actor: { type: "string" }
  optional_fields:
    session_id: { type: "string" }
    parent_correlation_id: { type: "string" }
    client_id: { type: "string" }
    org_id: { type: "string" }
    environment: { type: "string" }
    version: { type: "string" }
    metadata: { type: "object" }

trace_layers:
  reference: "$ref: LOGIC_09_INTERFACE#trace_output"
  user_facing:
    marker: "#trace"
    includes: ["Action summaries", "Key decisions", "Sources used", "Quality indicators"]
    excludes: ["Internal model prompts", "System IDs", "Raw tool names", "Technical error details"]
    format: { style: "narrative", max_items: 10, grouping: "by_phase" }
  audit_layer:
    marker: "#detail"
    includes: ["All events", "Full context", "Evidence citations", "HITL checkpoints", "Quality gate results", "Timestamps", "Correlation chain"]
    format: { style: "structured", include_all: true }
    access: { requires: "audit_role", logged: true }

sampling:
  strategies:
    always_sample:
      applies_to: ["hitl_triggered", "hitl_resolved", "error_occurred", "quality_gate_checked", "evidence_used"]
      sample_rate: 1.0
    high_sample:
      applies_to: ["session_start", "session_end", "use_case_started", "use_case_completed", "workflow_phase_entered", "workflow_phase_exited"]
      sample_rate: 0.9
    standard_sample:
      applies_to: ["request_received", "response_sent", "role_activated", "handoff"]
      sample_rate: 0.5
    low_sample:
      applies_to: ["tool_call", "checkpoint_created"]
      sample_rate: 0.1
  override:
    debug_mode: { sample_rate: 1.0 }
    high_risk: { sample_rate: 1.0 }

retention:
  tiers:
    hot:
      duration_days: 7
      storage: "primary_database"
      query_latency: "< 100ms"
    warm:
      duration_days: 30
      storage: "archive_database"
      query_latency: "< 5s"
    cold:
      duration_days: 365
      storage: "object_storage"
      query_latency: "< 60s"
    permanent:
      applies_to: ["hitl_resolved", "quality_gate_checked (failures)", "error_occurred (critical)"]
      storage: "compliance_archive"
  deletion:
    automatic: true
    gdpr_compliant: true
    on_client_request: "anonymize within 30 days"
  aggregation:
    at_transition:
      hot_to_warm: "none"
      warm_to_cold: "daily_rollup"
    preserve_raw: ["hitl events", "critical errors", "quality failures"]

redaction:
  always_redact:
    - pattern: "api_key"
      replacement: "[REDACTED_API_KEY]"
    - pattern: "password"
      replacement: "[REDACTED]"
    - pattern: "auth_token"
      replacement: "[REDACTED_TOKEN]"
    - pattern: "internal_id"
      replacement: "[INTERNAL]"
    - pattern: "model_prompt"
      replacement: "[PROMPT_REDACTED]"
  pii_patterns:
    email: { pattern: "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}", replacement: "[EMAIL_REDACTED]" }
    phone: { pattern: "\\+?[0-9]{10,15}", replacement: "[PHONE_REDACTED]" }
    ssn: { pattern: "\\d{3}-\\d{2}-\\d{4}", replacement: "[SSN_REDACTED]" }
  context_specific:
    user_facing_traces:
      redact: ["internal_id", "model_prompt", "raw_tool_name"]
    audit_traces:
      redact: ["api_key", "password", "auth_token"]
      preserve: ["internal_id", "correlation_id"]

trace_reconstruction:
  query_patterns:
    by_correlation_id: { index: "correlation_id" }
    by_session: { index: "session_id" }
    by_workflow: { index: "workflow_id" }
    by_time_range: { index: "timestamp" }
  reconstruction_steps:
    1: "Query events by correlation_id"
    2: "Sort by timestamp"
    3: "Build event graph using parent_correlation_id"
    4: "Apply redaction rules"
    5: "Format per requested layer (user/audit)"
  visualization:
    formats: ["timeline", "waterfall", "tree"]
    tools: ["built-in trace viewer", "export to Jaeger", "export to JSON"]
