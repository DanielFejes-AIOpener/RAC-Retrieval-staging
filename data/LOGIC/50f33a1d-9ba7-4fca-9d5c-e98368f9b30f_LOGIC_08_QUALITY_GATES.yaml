# LOGIC_08_QUALITY_GATES.yaml

meta:
  owner: "AI Opener"
  version: "2.0.0"
  last_updated: "2025-12-11"
  purpose: "Quality gates, evidence standards, and evaluation rules (SSOT)"
  notes: "v2.0 - Complete evidence tiers, reliability, schema, and universal gates"
  tags: [logic, quality, evidence, gates, ssot]

universal_gates:
  immutable: true
  entry:
    base:
      - "Context is sufficient for task"
      - "Required inputs are present and valid"
      - "No blocking errors in dependencies"
      - "Agent has required capabilities"
      - "USE_CASE not in ai_policy.prohibited_use_cases"
    use_case_additions:
      - "USE_CASE definition resolved"
      - "All capabilities_from roles available"
      - "Knowledge sources accessible"
      - "Persona configuration complete"
    workflow_additions:
      - "WORKFLOW definition resolved"
      - "Current phase entry conditions met"
      - "Previous phase exit confirmed"
      - "Required approvals obtained (if high-risk)"
      - "Checkpoint available for rollback"
  exit:
    base:
      - "Output meets quality standards"
      - "No unresolved errors"
      - "Audit trail complete"
      - "Evidence citations valid (if claims made)"
      - "AI disclosure applied per ai_policy"
    use_case_additions:
      - "Deliverable matches USE_CASE contract"
      - "Quality checklist passed"
      - "Voice and tone aligned with persona"
    workflow_additions:
      - "Phase deliverables complete"
      - "Handoff contract satisfied"
      - "Checkpoint created"
      - "Next phase notified"

evidence_tiers:
  immutable: true
  tier_1:
    name: "Primary Sources"
    authority: "highest"
    examples: ["Academic journals (peer-reviewed)", "Official government statistics", "Company financial reports (audited)", "Primary research studies", "Official regulatory documents", "Court decisions and legal rulings"]
    usage: "Required for quantitative claims"
    freshness_default_months: 24
  tier_2:
    name: "Secondary Sources"
    authority: "moderate"
    examples: ["Industry reports (Gartner, Forrester, McKinsey)", "Major news outlets (Reuters, AP, Bloomberg)", "Trade publications", "Case studies from reputable organizations", "Professional association publications"]
    usage: "Acceptable for general claims"
    freshness_default_months: 18
  tier_3:
    name: "Tertiary Sources"
    authority: "limited"
    examples: ["Blog posts", "Social media", "Unverified sources", "Opinion pieces", "User-generated content", "Anecdotal evidence"]
    usage: "Context only, not for claims"
    freshness_default_months: 12
    requires_disclaimer: true

source_reliability:
  immutable: true
  ratings:
    A:
      name: "Highly Reliable"
      trust_level: 1.0
      examples: ["Government statistical agencies", "Major peer-reviewed journals", "Established financial institutions"]
      usage: "Use confidently"
    B:
      name: "Reliable"
      trust_level: 0.85
      examples: ["Major industry analysts", "Quality news organizations", "Professional associations"]
      usage: "Use with standard citation"
    C:
      name: "Acceptable"
      trust_level: 0.65
      examples: ["Trade publications", "Company press releases", "Smaller research firms"]
      usage: "Verify if critical"
    D:
      name: "Low Reliability"
      trust_level: 0.4
      examples: ["Individual blogs", "Unverified social media", "Anonymous sources"]
      usage: "Requires prominent disclaimer"
      requires_disclaimer: true

combined_assessment:
  matrix:
    tier_1: { A: "Excellent", B: "Strong", C: "Acceptable", D: "Weak" }
    tier_2: { A: "Strong", B: "Good", C: "Acceptable", D: "Weak" }
    tier_3: { A: "Acceptable for background", B: "Context only", C: "Minimal use", D: "Avoid" }
  decision_rules:
    quantitative_claims: { minimum_tier: "tier_1", minimum_reliability: "B" }
    qualitative_claims: { minimum_tier: "tier_2", minimum_reliability: "C" }
    background_context: { minimum_tier: "tier_3", minimum_reliability: "C" }
    client_deliverables: { minimum_tier: "tier_2", minimum_reliability: "B" }
    public_content: { minimum_tier: "tier_1", minimum_reliability: "B" }

evidence_item_schema:
  required_fields:
    id: { type: "string", pattern: "ev-{source}-{topic}-{nnn}", validation: "Must be unique within evidence vault scope" }
    claim: { type: "string", max_length: 500, validation: "Must be a falsifiable statement" }
    source: { type: "string", max_length: 300 }
    source_date: { type: "date", format: "YYYY-MM-DD", validation: "Must be valid ISO date, not in future" }
    tier: { type: "enum", values: ["tier_1", "tier_2", "tier_3"] }
    source_reliability: { type: "enum", values: ["A", "B", "C", "D"] }
  optional_fields:
    valid_until: { type: "date", format: "YYYY-MM-DD", validation: "Must be >= source_date" }
    context: { type: "string", max_length: 200 }
    tags: { type: "array", items: "string", validation: "Should align with LOGIC_03_TAXONOMY" }
    url: { type: "string", format: "uri" }
    supersedes: { type: "string", validation: "Referenced ID must exist" }
    geography: { type: "string" }
    industry: { type: "string" }
  validation_rules:
    - "All required fields must be present"
    - "tier must be one of: tier_1, tier_2, tier_3"
    - "source_reliability must be one of: A, B, C, D"
    - "source_date must not be in future"
    - "valid_until (if present) must be >= source_date"
    - "id must be unique within evidence vault scope"

rag_evaluation:
  retrieval_metrics:
    recall_at_k: { target: 0.85, k_values: [5, 10, 20] }
    precision_at_k: { target: 0.70, k_values: [5, 10] }
    mrr: { target: 0.80 }
  generation_metrics:
    faithfulness: { target: 0.95, method: "LLM-as-judge" }
    answer_relevancy: { target: 0.90, method: "LLM-as-judge" }
    context_precision: { target: 0.85 }
    context_recall: { target: 0.80 }
  evaluation_triggers: ["Evidence tier below threshold", "Low retrieval confidence", "High-stakes output", "Quality gate checkpoint"]

freshness_requirements:
  by_category:
    market_data: { max_age_months: 12, action_when_stale: "flag_warning" }
    regulatory: { max_age_months: 0, action_when_stale: "block_usage" }
    statistics: { max_age_months: 24, action_when_stale: "flag_warning" }
    case_studies: { max_age_months: 36, action_when_stale: "flag_context" }
    frameworks: { max_age_months: null }
    benchmarks: { max_age_months: 18, action_when_stale: "flag_warning" }

libraries_gates:
  scoping_gate:
    type: "entry_gate"
    mandatory: true
    checks:
      org_match:
        validation: "library.org_id == runtime.org_id"
        on_failure: "block"
      client_match:
        validation: "library.client_id == runtime.client_id OR library.client_id is null"
        on_failure: "block"
      allowlist_membership:
        validation: "library.id in effective_allowlist"
        on_failure: "block"
    on_failure:
      action: "Block retrieval, capture policy event"
      trace_event: "library_scope_violation"
      policy_ref: "$ref: LOGIC_16_POLICY_CAPTURE#enforcement_actions.library_scope_violation"
  discovery_gate:
    type: "exit_gate"
    mandatory: true
    requires_one_of:
      option_a:
        name: "Libraries Selected"
        required_fields:
          - field: "selected_library_ids"
            type: "array"
            min_items: 1
          - field: "rationale"
            type: "string"
            min_length: 10
      option_b:
        name: "Gap Report"
        required_fields:
          - field: "library_gap_report"
            type: "object"
            schema: "$ref: #library_gap_report_schema"
          - field: "onboarding_recommendation"
            type: "string"
    on_failure:
      action: "Block progression, require discovery completion"

library_gap_report_schema:
  required_fields:
    gap_summary: { type: "string", max_length: 500 }
    domains_needed: { type: "array", items: "string", min_items: 1 }
    recommended_content: { type: "array", items: "string", min_items: 1 }
  optional_fields:
    priority: { type: "enum", values: ["high", "medium", "low"], default: "medium" }
    effort_estimate: { type: "string" }
    blocking_use_cases: { type: "array", items: "string" }
    workaround: { type: "string" }
    source_suggestions: { type: "array", items: "string" }
