# ══════════════════════════════════════════════════════════════════════════════
# LOGIC_08_QUALITY_GATES.yaml
# ══════════════════════════════════════════════════════════════════════════════

meta:
  owner: "AI Opener"
  version: "2.0.0"
  last_updated: "2025-12-11"
  purpose: "Quality gates, evidence standards, and evaluation rules (SSOT)"
  notes: "v2.0 - Complete evidence tiers, reliability, schema, and universal gates"
  tags: [logic, quality, evidence, gates, ssot]

# ══════════════════════════════════════════════════════════════════════════════
# UNIVERSAL GATES (SSOT)
# ══════════════════════════════════════════════════════════════════════════════

universal_gates:
  description: "Quality checkpoints required for all operations"
  immutable: true
  
  entry:
    base:
      - "Context is sufficient for task"
      - "Required inputs are present and valid"
      - "No blocking errors in dependencies"
      - "Agent has required capabilities"
      - "USE_CASE not in ai_policy.prohibited_use_cases"
      
    use_case_additions:
      - "USE_CASE definition resolved"
      - "All capabilities_from roles available"
      - "Knowledge sources accessible"
      - "Persona configuration complete"
      
    workflow_additions:
      - "WORKFLOW definition resolved"
      - "Current phase entry conditions met"
      - "Previous phase exit confirmed"
      - "Required approvals obtained (if high-risk)"
      - "Checkpoint available for rollback"
      
  exit:
    base:
      - "Output meets quality standards"
      - "No unresolved errors"
      - "Audit trail complete"
      - "Evidence citations valid (if claims made)"
      - "AI disclosure applied per ai_policy"
      
    use_case_additions:
      - "Deliverable matches USE_CASE contract"
      - "Quality checklist passed"
      - "Voice and tone aligned with persona"
      
    workflow_additions:
      - "Phase deliverables complete"
      - "Handoff contract satisfied"
      - "Checkpoint created"
      - "Next phase notified"

# ══════════════════════════════════════════════════════════════════════════════
# EVIDENCE TIERS (SSOT)
# ══════════════════════════════════════════════════════════════════════════════

evidence_tiers:
  description: "Classification of evidence sources by quality and authority"
  immutable: true
  
  tier_1:
    name: "Primary Sources"
    description: "Primary sources, peer-reviewed, official"
    authority: "highest"
    examples:
      - "Academic journals (peer-reviewed)"
      - "Official government statistics"
      - "Company financial reports (audited)"
      - "Primary research studies"
      - "Official regulatory documents"
      - "Court decisions and legal rulings"
    usage: "Required for quantitative claims"
    freshness_default_months: 24
    
  tier_2:
    name: "Secondary Sources"
    description: "Reputable secondary sources"
    authority: "moderate"
    examples:
      - "Industry reports (Gartner, Forrester, McKinsey)"
      - "Major news outlets (Reuters, AP, Bloomberg)"
      - "Trade publications"
      - "Case studies from reputable organizations"
      - "Professional association publications"
      - "Well-sourced Wikipedia articles"
    usage: "Acceptable for general claims"
    freshness_default_months: 18
    
  tier_3:
    name: "Tertiary Sources"
    description: "Tertiary sources, opinion, informal"
    authority: "limited"
    examples:
      - "Blog posts"
      - "Social media"
      - "Unverified sources"
      - "Opinion pieces"
      - "User-generated content"
      - "Anecdotal evidence"
    usage: "Context only, not for claims"
    freshness_default_months: 12
    requires_disclaimer: true

# ══════════════════════════════════════════════════════════════════════════════
# SOURCE RELIABILITY (SSOT)
# ══════════════════════════════════════════════════════════════════════════════

source_reliability:
  description: "Rating scale for source trustworthiness"
  immutable: true
  
  ratings:
    A:
      name: "Highly Reliable"
      description: "Verified, authoritative, consistently accurate"
      trust_level: 1.0
      examples:
        - "Government statistical agencies"
        - "Major peer-reviewed journals"
        - "Established financial institutions"
      usage: "Use confidently"
      
    B:
      name: "Reliable"
      description: "Reputable, generally accurate, occasional errors"
      trust_level: 0.85
      examples:
        - "Major industry analysts"
        - "Quality news organizations"
        - "Professional associations"
      usage: "Use with standard citation"
      
    C:
      name: "Acceptable"
      description: "Some verification needed, mixed track record"
      trust_level: 0.65
      examples:
        - "Trade publications"
        - "Company press releases"
        - "Smaller research firms"
      usage: "Verify if critical"
      
    D:
      name: "Low Reliability"
      description: "Use with caution, limited verification"
      trust_level: 0.4
      examples:
        - "Individual blogs"
        - "Unverified social media"
        - "Anonymous sources"
      usage: "Requires prominent disclaimer"
      requires_disclaimer: true

# ══════════════════════════════════════════════════════════════════════════════
# COMBINED ASSESSMENT (SSOT)
# ══════════════════════════════════════════════════════════════════════════════

combined_assessment:
  description: "How to use tier + reliability together for evidence decisions"
  
  matrix:
    tier_1:
      A: "Excellent - use confidently"
      B: "Strong - use with standard citation"
      C: "Acceptable - note source limitations"
      D: "Weak - seek better source"
      
    tier_2:
      A: "Strong - use with context"
      B: "Good - standard use case"
      C: "Acceptable - verify if critical"
      D: "Weak - supplement with better source"
      
    tier_3:
      A: "Acceptable for background"
      B: "Use for context only"
      C: "Minimal use, verify claims"
      D: "Avoid - find alternative"
      
  decision_rules:
    quantitative_claims:
      minimum_tier: "tier_1"
      minimum_reliability: "B"
      description: "Numbers, statistics, percentages"
      
    qualitative_claims:
      minimum_tier: "tier_2"
      minimum_reliability: "C"
      description: "Trends, opinions, assessments"
      
    background_context:
      minimum_tier: "tier_3"
      minimum_reliability: "C"
      description: "Scene-setting, non-critical context"
      
    client_deliverables:
      minimum_tier: "tier_2"
      minimum_reliability: "B"
      description: "Content going to client"
      
    public_content:
      minimum_tier: "tier_1"
      minimum_reliability: "B"
      description: "Content published externally"

# ══════════════════════════════════════════════════════════════════════════════
# EVIDENCE ITEM SCHEMA (SSOT)
# ══════════════════════════════════════════════════════════════════════════════

evidence_item_schema:
  description: "Required structure for all evidence vault items across layers"
  
  required_fields:
    id:
      type: "string"
      pattern: "ev-{source}-{topic}-{nnn}"
      description: "Unique identifier for evidence item"
      examples:
        - "ev-pack-linkedin-001"
        - "ev-org-benchmark-001"
        - "ev-client-stat-001"
      validation: "Must be unique within evidence vault scope"
      
    claim:
      type: "string"
      max_length: 500
      description: "The specific claim this evidence supports"
      validation: "Must be a falsifiable statement"
      
    source:
      type: "string"
      max_length: 300
      description: "Full citation of the source"
      examples:
        - "LinkedIn Talent Solutions, Global Recruiting Trends Report 2023"
        - "U.S. Bureau of Labor Statistics, Employment Situation Summary, Nov 2024"
      
    source_date:
      type: "date"
      format: "YYYY-MM-DD"
      description: "Publication or data collection date"
      validation: "Must be valid ISO date, not in future"
      
    tier:
      type: "enum"
      values: ["tier_1", "tier_2", "tier_3"]
      description: "Evidence tier per #evidence_tiers"
      
    source_reliability:
      type: "enum"
      values: ["A", "B", "C", "D"]
      description: "Source reliability rating per #source_reliability"
      
  optional_fields:
    valid_until:
      type: "date"
      format: "YYYY-MM-DD"
      description: "Expiration date for time-sensitive evidence"
      validation: "Must be >= source_date"
      
    context:
      type: "string"
      max_length: 200
      description: "Usage context, limitations, or approval status"
      examples:
        - "Approved by client for external use"
        - "Internal research only"
        - "B2B context, enterprise companies"
        
    tags:
      type: "array"
      items: "string"
      description: "Searchable tags for evidence categorization"
      validation: "Should align with LOGIC_03_TAXONOMY"
      
    url:
      type: "string"
      format: "uri"
      description: "Direct link to source if available"
      
    supersedes:
      type: "string"
      description: "ID of evidence item this replaces"
      validation: "Referenced ID must exist"
      
    geography:
      type: "string"
      description: "Geographic scope of the evidence"
      examples: ["Global", "US", "EU", "Netherlands"]
      
    industry:
      type: "string"
      description: "Industry scope if not general"
      
  validation_rules:
    - "All required fields must be present"
    - "tier must be one of: tier_1, tier_2, tier_3"
    - "source_reliability must be one of: A, B, C, D"
    - "source_date must be valid ISO date"
    - "source_date must not be in future"
    - "valid_until (if present) must be >= source_date"
    - "id must be unique within evidence vault scope"
    - "claim must be under 500 characters"
    
  example:
    id: "ev-pack-linkedin-001"
    claim: "Companies with strong employer brands see 50% reduction in cost-per-hire"
    source: "LinkedIn Talent Solutions, Global Recruiting Trends Report 2023"
    source_date: "2023-01-15"
    tier: "tier_2"
    source_reliability: "B"
    valid_until: "2025-01-15"
    context: "B2B context, enterprise companies"
    tags: ["employer_branding", "recruitment", "cost_reduction"]

# ══════════════════════════════════════════════════════════════════════════════
# RAG EVALUATION
# ══════════════════════════════════════════════════════════════════════════════

rag_evaluation:
  description: "Quality metrics for RAG retrieval and generation"
  
  retrieval_metrics:
    recall_at_k:
      description: "Proportion of relevant documents retrieved"
      target: 0.85
      k_values: [5, 10, 20]
      
    precision_at_k:
      description: "Proportion of retrieved documents that are relevant"
      target: 0.70
      k_values: [5, 10]
      
    mrr:
      description: "Mean Reciprocal Rank - position of first relevant result"
      target: 0.80
      
  generation_metrics:
    faithfulness:
      description: "Factual consistency with retrieved context"
      target: 0.95
      method: "LLM-as-judge"
      
    answer_relevancy:
      description: "How well answer addresses the query"
      target: 0.90
      method: "LLM-as-judge"
      
    context_precision:
      description: "Relevance of retrieved context to query"
      target: 0.85
      
    context_recall:
      description: "Coverage of required information in context"
      target: 0.80
      
  evaluation_triggers:
    - "Evidence tier below threshold"
    - "Low retrieval confidence"
    - "High-stakes output"
    - "Quality gate checkpoint"

# ══════════════════════════════════════════════════════════════════════════════
# FRESHNESS REQUIREMENTS
# ══════════════════════════════════════════════════════════════════════════════

freshness_requirements:
  description: "Maximum age for evidence by category"
  
  by_category:
    market_data:
      max_age_months: 12
      action_when_stale: "flag_warning"
      
    regulatory:
      max_age_months: 0
      description: "Must be current version"
      action_when_stale: "block_usage"
      
    statistics:
      max_age_months: 24
      exception: "Historical data clearly labeled as such"
      action_when_stale: "flag_warning"
      
    case_studies:
      max_age_months: 36
      action_when_stale: "flag_context"
      
    frameworks:
      max_age_months: null
      description: "No expiry for conceptual frameworks"
      
    benchmarks:
      max_age_months: 18
      action_when_stale: "flag_warning"

# ══════════════════════════════════════════════════════════════════════════════
# LIBRARIES QUALITY GATES (SSOT)
# ══════════════════════════════════════════════════════════════════════════════
# Referenced by: LOGIC_06_ORCHESTRATION#library_discovery_step
# Enforcement: Mandatory for all LIBRARIES retrieval operations

libraries_gates:
  description: "Quality gates specific to LIBRARIES layer operations"
  
  scoping_gate:
    description: "Verify library retrieval respects scope boundaries"
    type: "entry_gate"
    mandatory: true
    
    checks:
      org_match:
        description: "Library org_id matches runtime org"
        validation: "library.org_id == runtime.org_id"
        on_failure: "block"
        
      client_match:
        description: "Library client_id matches runtime client (when applicable)"
        validation: "library.client_id == runtime.client_id OR library.client_id is null"
        on_failure: "block"
        
      allowlist_membership:
        description: "Library is on effective allowlist"
        validation: "library.id in effective_allowlist"
        on_failure: "block"
        
    on_failure:
      action: "Block retrieval, capture policy event"
      trace_event: "library_scope_violation"
      policy_ref: "$ref: LOGIC_16_POLICY_CAPTURE#enforcement_actions.library_scope_violation"
      
  discovery_gate:
    description: "Require either library selection or gap report"
    type: "exit_gate"
    mandatory: true
    
    requires_one_of:
      option_a:
        name: "Libraries Selected"
        required_fields:
          - field: "selected_library_ids"
            type: "array"
            min_items: 1
          - field: "rationale"
            type: "string"
            min_length: 10
        description: "At least one library selected with justification"
        
      option_b:
        name: "Gap Report"
        required_fields:
          - field: "library_gap_report"
            type: "object"
            schema: "$ref: #library_gap_report_schema"
          - field: "onboarding_recommendation"
            type: "string"
        description: "No relevant library, with onboarding guidance"
        
    on_failure:
      action: "Block progression, require discovery completion"
      message: "Library discovery incomplete: must either select libraries or produce gap report"

# ══════════════════════════════════════════════════════════════════════════════
# LIBRARY GAP REPORT SCHEMA (SSOT)
# ══════════════════════════════════════════════════════════════════════════════
# Referenced by: LOGIC_06_ORCHESTRATION#library_discovery_step.outputs.output_b_gap

library_gap_report_schema:
  description: "Schema for reporting missing library coverage to guide onboarding"
  
  required_fields:
    gap_summary:
      type: "string"
      max_length: 500
      description: "Brief description of what knowledge is missing"
      examples:
        - "No RFP examples or proposal templates found for this client"
        - "Missing brand guidelines and approved messaging library"
        
    domains_needed:
      type: "array"
      items: "string"
      min_items: 1
      description: "Knowledge domains that would fulfill the need"
      examples:
        - ["rfp_examples", "proposal_templates", "pricing_history"]
        - ["brand_guidelines", "messaging_library", "visual_assets"]
        
    recommended_content:
      type: "array"
      items: "string"
      min_items: 1
      description: "Specific types of documents/exemplars to add"
      examples:
        - ["Past winning RFPs (3-5 examples)", "Proposal template with sections", "Rate card"]
        - ["Brand book PDF", "Approved taglines list", "Logo usage guidelines"]
        
  optional_fields:
    priority:
      type: "enum"
      values: ["high", "medium", "low"]
      description: "Urgency of filling this gap"
      default: "medium"
      
    effort_estimate:
      type: "string"
      description: "Estimated effort to onboard required content"
      examples:
        - "~2 hours to gather and upload existing materials"
        - "~1 week to create missing documentation"
        
    blocking_use_cases:
      type: "array"
      items: "string"
      description: "USE_CASE IDs that cannot run without this library"
      
    workaround:
      type: "string"
      description: "Temporary alternative if gap cannot be immediately filled"
      examples:
        - "Can proceed with generic templates from PACKS, but quality will be lower"
        - "Manual input required for brand-specific elements"
        
    source_suggestions:
      type: "array"
      items: "string"
      description: "Where to find the needed content"
      examples:
        - ["SharePoint > Sales > Won Deals", "CRM attachment storage"]
        - ["Marketing drive > Brand folder", "Agency brand portal"]
        
  example:
    gap_summary: "No client-specific case studies or testimonials found"
    domains_needed:
      - "case_studies"
      - "testimonials"
      - "success_metrics"
    recommended_content:
      - "2-3 completed case studies with metrics"
      - "Client testimonial quotes (with approval)"
      - "Before/after performance data"
    priority: "high"
    effort_estimate: "~4 hours to gather from past project folders"
    blocking_use_cases:
      - "USE_CASE_05_CASE_STUDY_WRITER"
    workaround: "Can use anonymized examples from PACKS but loses client-specific proof points"