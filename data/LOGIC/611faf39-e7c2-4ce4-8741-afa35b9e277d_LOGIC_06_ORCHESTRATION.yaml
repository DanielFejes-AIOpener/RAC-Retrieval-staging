# LOGIC_06_ORCHESTRATION.yaml

meta:
  owner: "AI Opener"
  version: "2.0.0"
  last_updated: "2025-01-06"
  purpose: "Orchestration mode definitions, guidance, and Orchestrator contract (SSOT)"
  notes: "v2.1 - Mode schemas only; selection is Orchestrator + USE_CASE responsibility"
  tags: [logic, orchestration, ssot]

orchestration_modes:
  modes:
    SOM:
      name: "Single Output Mode"
      characteristics:
        - "Single, clear objective"
        - "One role handles entire task"
        - "No handoffs or phase transitions"
        - "Minimal context assembly"
      constraints:
        max_capabilities: 2
        max_steps: 3
        hitl_checkpoints: 0
      qa_profile: "lean"
      trace_level: "minimal"
      required_gates: []
      typical_use_cases: ["Simple Q&A", "Single document generation", "Quick calculations", "Status checks"]

    SAM:
      name: "Sequential Agent Mode"
      characteristics:
        - "Multi-step but coherent task"
        - "Single role with full capability set"
        - "Maintains state across steps"
        - "Self-orchestrated within session"
      constraints:
        max_capabilities: 5
        max_steps: 10
        hitl_checkpoints: 1
      qa_profile: "structured"
      trace_level: "full"
      required_gates: ["exit_review"]
      typical_use_cases: ["Document with research", "Analysis with recommendations", "Content with revisions", "Plan development"]

    Wizard:
      name: "Wizard Mode"
      characteristics:
        - "Requirements may be unclear initially"
        - "Multiple specialized roles possible"
        - "Explicit handoffs between phases"
        - "HITL checkpoints throughout"
      constraints:
        max_capabilities: null
        max_steps: null
        hitl_checkpoints: null
      qa_profile: "structured"
      trace_level: "full"
      required_gates: ["consent_gate", "phase_approval", "exit_review"]
      typical_use_cases: ["Campaign development", "Strategy creation", "Multi-deliverable projects", "Requirements unclear upfront"]

mode_selection_guidance:
  purpose: |
    Helps builder wizard suggest appropriate mode during USE_CASE creation.
    Orchestrator makes runtime decisions when USE_CASE.typical_mode needs override.
    Human always has final say during USE_CASE creation.

  guidance_by_mode:
    SOM:
      appropriate_when:
        - "Single capability needed"
        - "No external dependencies or approvals"
        - "Low risk, internal use"
        - "Quick turnaround expected"
      not_appropriate_when:
        - "Multiple handoffs needed"
        - "Public-facing output requiring review"
        - "Requires human checkpoints"
    SAM:
      appropriate_when:
        - "Multiple capabilities but single coherent task"
        - "Needs research + synthesis"
        - "Public-facing but single reviewer sufficient"
        - "Multi-step with maintained context"
      not_appropriate_when:
        - "Trivial single-shot task (use SOM)"
        - "Requires multiple specialized roles"
        - "Complex approval workflows"
    Wizard:
      appropriate_when:
        - "Requirements unclear, needs iterative clarification"
        - "Multiple specialized roles required"
        - "Complex approval or review workflows"
        - "High-stakes or regulated output"
      not_appropriate_when:
        - "Simple, well-defined task"
        - "Time-critical with no room for iteration"

use_case_integration:
  typical_mode_field:
    field_name: "typical_mode"
    location: "use_case_definition.typical_mode"
    type: "enum"
    values: ["SOM", "SAM", "Wizard"]
    required: false
    default: "SOM"
  runtime_behavior:
    - "Orchestrator reads USE_CASE.typical_mode as starting point"
    - "Orchestrator evaluates actual task context"
    - "Orchestrator may upgrade mode if task is more complex"
    - "Orchestrator may downgrade mode if task is simpler"
    - "Override decision is logged for trace"

use_case_registry:
  registry_structure:
    entry_schema:
      id: { type: "string", pattern: "USE_CASE_{NN}_{NAME}", required: true }
      name: { type: "string", required: true }
      primary_capability: { type: "string", required: true }
      secondary_capabilities: { type: "array", required: false }
      typical_mode: { type: "enum", values: ["SOM", "SAM", "Wizard"], default: "SOM" }
      use_case_file: { type: "string", pattern: "USE_CASE_*.yaml" }
      workflow_file: { type: "string", pattern: "WORKFLOW_*.yaml" }
  resolution_priority:
    order:
      1: "CLIENT.use_cases.custom"
      2: "ORG.use_case_registry.custom"
      3: "USE_CASES layer (standard)"
    conflict_rule: "CLIENT wins per $ref: LOGIC_02_RETRIEVAL#override_rules"
  fallback_behavior:
    if_no_match:
      action: "Route to ROLE_01_ORCHESTRATOR"
      behavior: "Orchestrator determines best-fit role by capability"
  discovery:
    auto_register: true
    scan_patterns: ["USE_CASE_*.yaml", "WORKFLOW_*.yaml"]
    refresh_on: "startup"

simulation_mode:
  modes:
    sandbox:
      behavior: ["All tool calls mocked", "No external API calls", "No data persistence", "Full trace preserved"]
      activation: "demo_mode: true OR explicit sandbox request"
    dry_run:
      behavior: ["Generate execution plan", "Validate all steps", "Estimate resources/time", "No actual execution"]
      activation: "Explicit dry_run request"
    shadow:
      behavior: ["Run both paths", "Compare outputs", "Log differences", "Production result used"]
      activation: "shadow_mode: true in CONFIG"
  simulation_hooks:
    pre_execution: ["Validate simulation mode is permitted", "Configure mock responses", "Initialize trace capture"]
    post_execution: ["Generate simulation report", "Compare with expectations", "Store for analysis"]

orchestrator_contract:
  orchestrator_role: "ROLE_01_ORCHESTRATOR"
  inputs:
    task_description: "The user's request"
    use_case_id: "Matched USE_CASE (if any)"
    typical_mode_hint: "USE_CASE.typical_mode value"
    runtime_context: ["Active CLIENT/ORG configuration", "Available roles and capabilities", "Current session state", "Governance constraints"]
  outputs:
    selected_mode: "SOM | SAM | Wizard"
    routing_target: "ROLE_ID | USE_CASE_ID | WORKFLOW_ID"
    context_additions: "Additional context to load"
    override_reason: "If mode differs from typical_mode hint, explain why"
  override_authority:
    conditions:
      - "Task context differs significantly from typical"
      - "Governance requires higher mode (e.g., HITL triggers Wizard)"
      - "Resource constraints require lower mode"
    logging: "All overrides logged with reason for trace"
  fallback_behavior:
    if_no_use_case_match:
      action: "Orchestrator determines best-fit role by capability matching"
    if_orchestrator_uncertain:
      action: "Escalate to human via HITL"
      reference: "$ref: LOGIC_09_INTERFACE#hitl_triggers"

library_discovery_step:
  contract_name: "discover-or-gap"
  inputs:
    brief:
      required: true
    diagnostic_answers:
      required: true
      fields: ["runtime.org_id", "runtime.client_id (if applicable)", "domains/topics needed", "constraints", "intended outputs"]
  process:
    1_manifest_scan:
      scope: "org_id (+ client_id when applicable)"
      action: "Query library manifests within permitted scope"
      output: "List of potentially relevant libraries"
    2_shortlist:
      criteria: ["Scoping rules (org/client match)", "Effective allowlist membership", "Descriptor/tag relevance", "Owner/doc_type alignment"]
      output: "Shortlisted library IDs"
    3_probe_retrieval:
      method: "Quick queries to validate relevance/coverage"
      metrics: ["Top similarity scores", "Hit count above threshold", "Distinct source doc coverage"]
      output: "Relevance assessment per library"
    4_select_or_gap:
      decision_rule: "If probe retrieval shows relevant coverage --> Output A; If no eligible libraries OR probes fail minimum relevance --> Output B"
  outputs:
    output_a_selected:
      schema:
        selected_library_ids: { type: "array", items: "string" }
        rationale: { type: "string" }
      quality_gate: "$ref: LOGIC_08_QUALITY_GATES#libraries_gates.discovery_gate"
    output_b_gap:
      schema:
        library_gap_report: { type: "object", reference: "$ref: LOGIC_08_QUALITY_GATES#library_gap_report_schema" }
        onboarding_recommendation: { type: "string" }
      action: "Surface gap to user, suggest onboarding"
  no_relevant_library_conditions:
    condition_1_no_eligible:
      trigger: "No eligible libraries exist after scoping rules, allowlist resolution, health/availability checks"
    condition_2_probe_fails:
      trigger: "Eligible libraries exist but probe retrieval fails minimum relevance"
      thresholds:
        score: "Top similarity scores below minimum"
        hits: "Too few results above threshold"
        docs: "Insufficient distinct source docs"
  integration:
    when_to_invoke: "During USE_CASE/WORKFLOW initialization when knowledge_from includes LIBRARIES"
    fallback_behavior: "If gap, proceed with PACKS-only but surface gap report"
    trace_event: "library_discovery_completed"
