# LOGIC_17_IMAGE_GENERATION.yaml

meta:
  owner: "AI Opener"
  version: "2.0.0"
  last_updated: "2025-12-11"
  purpose: "Visual AI mechanics and image generation configuration (SSOT)"
  notes: "v2.0 - Image generation patterns with safety and accessibility"
  tags: [logic, image, generation, ssot]

references:
  interface_output_standards:
    codebox_conventions: "$ref: LOGIC_09_INTERFACE#output_standards.formatting"
    accessibility: "$ref: LOGIC_09_INTERFACE#output_standards.accessibility"
    dei_requirements: "$ref: LOGIC_09_INTERFACE#output_standards.dei_requirements"
  visual_system_expected_source:
    org_default_visual_identity:
      reference: "$ref: ORG_06_VISUAL_SYSTEM#visual_system.visual_identity"
      fallback_paths: ["ORG_06_VISUAL_SYSTEM#visual_system.visual_dna_default", "ORG_06_VISUAL_SYSTEM#design_qa"]
    client_override_expected:
      canonical_path: "CLIENT.*.visual_identity (overlay)"
      behavior: "If runtime.client_id is set and CLIENT visual identity exists, merge (CLIENT overrides ORG)"

engine_capabilities:
  nano_banana:
    supports_negative_prompt: false
    supports_seed: false
    max_num_images: 4
    allowed_aspect_ratios: ["1:1", "4:5", "3:4", "16:9", "9:16"]
    allowed_resolutions: ["1k", "2k", "4k"]
    allowed_output_formats: ["png", "jpeg", "webp"]

image_prompt_package_contract:
  required_fields: ["effective_visual_dna_ref", "creative_brief", "constraints", "nano_banana_payload", "refs_used", "qa_check"]
  constraints_schema:
    do_dont: "Lists from Visual DNA"
    negative_constraints: "Brand negatives stored as constraints (not as API field)"
    style_tokens_used: "Which Visual DNA elements were applied"
  nano_banana_payload_schema:
    prompt: "Full-sentence prompt (includes translated constraints)"
    aspect_ratio: "One of allowed aspect ratios"
    resolution: "1k|2k|4k"
    output_format: "png|jpeg|webp"
    num_images: "1-4"
    reference_images: "Optional list of URLs/IDs/pointers (external only)"
  validation_rules:
    - "Output exactly ONE image_prompt_package in a single yaml codebox"
    - "Store Visual DNA negatives as constraints.negative_constraints (not API field)"
    - "nano_banana_payload MUST NOT contain: negative_prompt, seed"
    - "If user requests > 4 images, set num_images to 4 and record clamp in qa_check"
    - "refs_used may be empty list"

image_generation_flow:
  steps:
    - id: "resolve_active_scope"
      outputs: ["active_scope: ORG|CLIENT", "active_client_id (optional)"]
    - id: "load_visual_system"
      expected_sources:
        org: { reference: "$ref: ORG_06_VISUAL_SYSTEM#visual_system.visual_identity" }
        org_fallbacks: ["ORG_06_VISUAL_SYSTEM#visual_system.visual_dna_default", "ORG_06_VISUAL_SYSTEM#design_qa"]
      merge_rule: "ORG is default; CLIENT overrides ORG when keys collide"
    - id: "validate_visual_system_minimums"
      minimum_required_inputs:
        brand_dna_caption:
          accepted_source_paths: ["visual_identity.brand_dna_caption", "visual_dna_default.dna_caption"]
        do_dont:
          accepted_source_paths: ["visual_identity.do_dont", "visual_dna_default.do_dont"]
      optional_inputs:
        reference_pointers:
          accepted_source_paths: ["visual_identity.external_reference_sets", "visual_dna_default.external_reference_sets"]
      on_missing:
        action: "Return missing_fields response per output_rules.missing_visual_system_minimums"
    - id: "compose_image_prompt_package"
      output_contract: "$ref: #image_prompt_package_contract"
      determinism_controls:
        - "Derive constraints.style_tokens_used only from visual system + explicit user overrides"
        - "Store Visual DNA do/don't and negatives in constraints (engine-agnostic)"
        - "For engines without negative prompt, translate into positive 'Avoid/Do notâ€¦' instruction sentences"
        - "Do not include seed in nano_banana_payload"
        - "Include refs_used only when pointers exist (may be empty)"
        - "Do not generate images or call tools in this flow"
    - id: "return_package_only"

output_rules:
  when_user_asks_for_images:
    must_output: "Exactly ONE image_prompt_package"
    format: { requirement: "Single codebox only", codebox_language_hint: "yaml", outside_codebox_text: "forbidden" }
    allowed_top_level_keys_in_codebox: ["image_prompt_package"]
    must_conform_to_contract: "$ref: #image_prompt_package_contract"
  missing_visual_system_minimums:
    format: { requirement: "Single codebox only", codebox_language_hint: "yaml", outside_codebox_text: "forbidden" }
    required_keys_in_codebox: ["missing_fields", "onboarding_ask"]
    onboarding_ask_rules: ["Ask only for minimum needed (brand_dna_caption and do/don't)", "Do not ask for content beyond visual system"]

image_generation:
  enabled:
    source: "$ref: CONFIG_00_INSTANCE#features.image_generation"
    default: false
  providers:
    dall_e_3:
      provider: "openai"
      model: "dall-e-3"
      capabilities: ["text_to_image", "high_quality", "style_control"]
      sizes: ["1024x1024", "1024x1792", "1792x1024"]
      quality_options: ["standard", "hd"]
      style_options: ["vivid", "natural"]
      rate_limit: { images_per_minute: 5 }
    dall_e_2:
      provider: "openai"
      model: "dall-e-2"
      capabilities: ["text_to_image", "image_editing", "variations"]
      sizes: ["256x256", "512x512", "1024x1024"]
      rate_limit: { images_per_minute: 10 }
    stable_diffusion:
      provider: "stability"
      model: "stable-diffusion-xl"
      capabilities: ["text_to_image", "image_to_image", "inpainting"]
      sizes: ["512x512", "768x768", "1024x1024"]
      rate_limit: { images_per_minute: 20 }
    midjourney:
      provider: "midjourney"
      capabilities: ["text_to_image", "style_variations"]
  default_provider: { source: "dall_e_3" }

prompt_engineering:
  prompt_structure:
    recommended_order: [1, "Subject/main focus", 2, "Action or state", 3, "Environment/setting", 4, "Style/aesthetic", 5, "Lighting/mood", 6, "Technical specifications"]
  style_templates:
    corporate: { modifiers: ["professional", "corporate", "clean", "modern", "high quality"] }
    marketing: { modifiers: ["vibrant", "engaging", "eye-catching", "commercial quality"] }
    editorial: { modifiers: ["documentary", "authentic", "storytelling", "natural"] }
    abstract: { modifiers: ["abstract", "conceptual", "artistic", "creative"] }
    technical: { modifiers: ["diagram", "technical illustration", "schematic", "clean lines"] }
  brand_integration:
    elements:
      colors: { source: "active_visual_system.palette", application: "Use palette as constraints; never include forbidden colors" }
      style: { source: "active_visual_system.style_keywords", application: "Add only listed style tokens; record in constraints.style_tokens_used" }
      avoid: { source: "active_visual_system.negative_prompts + do_dont.dont", application: "Store as constraints.negative_constraints" }

payload_mapping:
  nano_banana:
    source_of_truth:
      visual_dna: "ORG_06_VISUAL_SYSTEM.visual_system.visual_dna_default"
      qa_checklist: "ORG_06_VISUAL_SYSTEM.design_qa.checklist"
    translation_rules:
      - "Do NOT output separate negative_prompt field for Nano-Banana"
      - "Translate Visual DNA negative_prompts.brand[] into positive instruction sentences"
      - "If user requests > 4 images, set num_images to 4 and note in qa_check"
      - "Do NOT include seed; use reference images for consistency"
    prompt_skeleton: ["Subject", "Composition", "Action (if any)", "Setting", "Style (from Visual DNA)", "Instructions (translated constraints + do/don't)"]

size_and_format:
  aspect_ratios:
    square: { ratio: "1:1", use_cases: ["Social media posts", "Profile images", "Thumbnails"], sizes: ["256x256", "512x512", "1024x1024"] }
    landscape: { ratio: "16:9", use_cases: ["Website headers", "Blog featured images", "Presentations"], sizes: ["1024x576", "1792x1024"] }
    portrait: { ratio: "9:16", use_cases: ["Social stories", "Mobile content", "Vertical ads"], sizes: ["576x1024", "1024x1792"] }
    banner: { ratio: "3:1", use_cases: ["Email headers", "LinkedIn banners", "Website banners"], sizes: ["1200x400", "1500x500"] }
  by_channel:
    linkedin: { post: "1200x627", profile: "400x400", banner: "1584x396" }
    twitter: { post: "1200x675", profile: "400x400", header: "1500x500" }
    instagram: { post: "1080x1080", story: "1080x1920" }
    facebook: { post: "1200x630", profile: "180x180", cover: "820x312" }
  output_formats:
    supported:
      - format: "PNG"
        use_case: "High quality, transparency"
      - format: "JPEG"
        use_case: "Web, smaller file size"
      - format: "WEBP"
        use_case: "Modern web, best compression"
    default: "PNG"

safety:
  immutable: true
  pre_generation_checks:
    checks:
      - check: "No prohibited content in prompt"
        prohibited_content: "$ref: #prohibited_content"
        action: "Block generation"
      - check: "No real person names"
        action: "Warn and require confirmation"
      - check: "No trademark/brand misuse"
        action: "Block or require approval"
      - check: "Compliance with brand guidelines"
        source: "active_visual_system"
        action: "Warn if potential conflict"
  post_generation_checks:
    checks:
      - check: "Content moderation scan"
        method: "Provider's built-in moderation"
        action: "Flag or block if unsafe"
      - check: "Brand safety"
        method: "Visual similarity check"
        action: "Flag for review"
  prohibited_content:
    categories: ["Violence or gore", "Sexual or adult content", "Hate symbols or content", "Real people without consent", "Copyrighted characters", "Misleading/deceptive imagery", "Illegal activities"]
  deny_lists: { terms: [] }
  safe_lists: { terms: [] }

accessibility:
  reference: "$ref: LOGIC_09_INTERFACE#output_standards.accessibility"
  alt_text:
    required: true
    generation:
      method: "Auto-generate from prompt and image analysis"
      components: ["Main subject", "Action/state", "Context/setting"]
      max_length: 125
    review: { recommended: true }
  color_considerations:
    guidelines: ["Avoid color-only information", "Ensure sufficient contrast", "Consider colorblind users"]
    checks:
      - check: "Contrast ratio"
        minimum: "4.5:1"
  text_in_images:
    guidelines: ["Minimize text in images", "Include text in alt_text", "Ensure readability"]
    minimum_font_size: "12pt equivalent"

dei_requirements:
  reference: "$ref: LOGIC_09_INTERFACE#output_standards.dei_requirements"
  representation:
    guidelines: ["Vary demographics across image sets", "Avoid stereotypical portrayals", "Include diverse body types, ages, abilities", "Represent diverse settings and contexts"]
    prompt_guidance:
      for_people: "Specify diverse representation or leave open"
      avoid: "Stereotypical associations"
  bias_awareness:
    known_issues: ["Default to certain demographics", "Stereotypical role associations", "Western-centric aesthetics"]
    mitigations: ["Explicit diversity in prompts", "Review generated sets for balance", "Client approval for representation"]
  cultural_sensitivity:
    guidelines: ["Research cultural context", "Avoid cultural appropriation", "Respect religious symbols", "Consider regional norms"]

resilience:
  reference: "$ref: LOGIC_10_TOOLS_CORE#resilience_patterns"
  retry_config: { max_attempts: 3, initial_delay_ms: 2000, backoff_multiplier: 2.0 }
  fallback_strategies:
    provider_fallback: { order: ["dall_e_3", "stable_diffusion", "dall_e_2"] }
    prompt_simplification: { steps: ["Remove complex modifiers", "Reduce specificity", "Try generic style"] }
    stock_image_fallback: { action: "Provide search terms for stock libraries" }
    placeholder: { action: "Return text description of intended image" }
  error_handling:
    content_policy_violation: { action: "Review and modify prompt", user_message: "The image couldn't be generated due to content policies. Let me suggest an alternative approach." }
    rate_limit: { action: "Queue and retry", user_message: "Image generation is queued and will complete shortly." }
    provider_error: { action: "Try fallback provider", user_message: "Trying alternative image generation service." }

governance:
  risk_classification:
    default: "limited_risk"
    high_risk_triggers: ["Images for regulated industries", "Images depicting people", "Images for public campaigns"]
    governance_ref: "$ref: LOGIC_12_GOVERNANCE#risk_classification"
  approval_requirements:
    internal_use: { approval: "optional" }
    external_use: { approval: "recommended" }
    public_campaigns: { approval: "required", approvers: ["creative_director", "brand_manager"] }
    people_imagery: { approval: "required", approvers: ["legal", "brand_manager"] }
  ai_disclosure:
    required_for: ["External publications", "Client deliverables"]
    template: "AI-generated image"
    placement: "Image caption or metadata"
  audit:
    track: ["prompt", "provider", "timestamp", "requester", "approval_status"]
    retention: "$ref: LOGIC_11_TRACE#retention"
