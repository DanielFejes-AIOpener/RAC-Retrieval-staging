# LOGIC_10_TOOLS_CORE.yaml

meta:
  owner: "AI Opener"
  version: "2.2.0"
  last_updated: "2026-02-03"
  purpose: "Unified tools core: tool registry, capability routing, and execution mechanics (SSOT)"
  notes: "v2.2.0 - Renamed tool_search_rag to vector_search, removed deprecated tools (tool_data_analytics, TOOL_IMAGE_PROMPT_PACKAGE_ONLY, tool_util_calculate), fixed tool arguments for manual_handoff, create_document_access, edit_document, look_for_document"
  tags: [logic, tools, api, resilience, ssot]

tool_schema:
  required_fields:
    id: { type: "string", pattern: "tool_{category}_{name}" }
    name: { type: "string" }
    category: { type: "enum", values: ["search", "data", "integration", "generation", "utility"] }
    input_schema: { type: "object" }
    output_schema: { type: "object" }
  optional_fields:
    auth_required: { type: "boolean", default: false }
    rate_limit: { type: "object", properties: { requests_per_minute: "integer", requests_per_day: "integer" } }
    timeout_ms: { type: "integer", default: 30000 }
    retry_config: { type: "object", reference: "$ref: #resilience_patterns.retry" }
    circuit_breaker: { type: "object", reference: "$ref: #resilience_patterns.circuit_breaker" }
    fallback: { type: "string" }

tool_registry:
  tools:
    tool_search_web:
      id: "tool_search_web"
      name: "Web Search"
      category: "search"
      input_schema:
        type: "object"
        properties:
          query: { type: "string", required: true }
          max_results: { type: "integer", default: 10 }
      output_schema:
        type: "object"
        properties:
          results: { type: "array", items: { properties: { title: "string", url: "string", snippet: "string" } } }
      timeout_ms: 10000
      rate_limit: { requests_per_minute: 60 }

    query_rac:
      id: "query_rac"
      name: "Query RAC"
      category: "data"
      input_schema:
        type: "object"
        properties:
          path: { type: "string", required: true }
          client: { type: "string" }
        required: ["path"]
      output_schema:
        type: "object"
        properties:
          path: { type: "string" }
          resolved: { type: "boolean" }
          content: { type: "object" }
      timeout_ms: 5000
      rate_limit: { requests_per_minute: 120 }

    vector_search:
      id: "vector_search"
      name: "Vector Search"
      category: "search"
      input_schema:
        type: "object"
        properties:
          query: { type: "string", required: true }
          chunks: { type: "integer", default: 10, description: "Number of chunks to return" }
        required: ["query"]
      output_schema:
        type: "object"
        properties:
          results: { type: "array", items: { properties: { content: "string", source: "string", score: "number", metadata: "object" } } }
      config_ref: "$ref: LOGIC_05_RAG_MECHANICS#retrieval_pipeline"

    tool_gen_image:
      id: "tool_gen_image"
      name: "Image Generation"
      category: "generation"
      governance: "$ref: LOGIC_17_IMAGE_GENERATION"
      input_schema:
        type: "object"
        properties:
          prompt: { type: "string", required: true }
          style: { type: "string" }
          size: { type: "string", enum: ["256x256", "512x512", "1024x1024"] }
      output_schema:
        type: "object"
        properties:
          image_url: "string"
          alt_text: "string"
      timeout_ms: 60000

    TOOL_IMAGE_NANO_BANANA:
      id: "TOOL_IMAGE_NANO_BANANA"
      name: "Nano-Banana Image Rendering"
      category: "generation"
      governance: "$ref: LOGIC_17_IMAGE_GENERATION"
      constraints:
        max_variants: 4
        allowed_aspect_ratios: ["1:1", "4:5", "3:4", "16:9", "9:16"]
        reference_images_optional: true
      input_schema:
        type: "object"
        additionalProperties: false
        properties:
          prompt: { type: "string", required: true }
          negative_prompt: { type: "string", default: "" }
          aspect_ratio: { type: "string", enum: ["1:1", "4:5", "3:4", "16:9", "9:16"], default: "1:1" }
          num_variants: { type: "integer", minimum: 1, maximum: 4, default: 1 }
          seed: { type: "integer" }
          reference_image_urls_or_ids: { type: "array", items: { type: "string" } }
      output_schema:
        type: "object"
        properties:
          images: { type: "array", items: { type: "string" } }
          metadata: { type: "object", properties: { provider: "string", model: "string", version: "string", settings: "object" } }
          safety_flags: { type: "array", items: { properties: { code: "string", severity: "string", message: "string" } } }
        required: ["images", "metadata"]
      timeout_ms: 60000
      retry_config: "$ref: #resilience_patterns.retry.default_config"

    perplexity_tool:
      id: "perplexity_tool"
      name: "Perplexity"
      category: "search"
      input_schema:
        type: "object"
        properties:
          query: { type: "string", required: true }
        required: ["query"]
      output_schema:
        type: "object"
        properties:
          results: { type: "array" }

    manual_handoff_tool:
      id: "manual_handoff_tool"
      name: "Manual Handoff"
      category: "utility"
      input_schema:
        type: "object"
        properties:
          agent: { type: "string", required: true, description: "Who to hand off to" }
          message: { type: "string", required: true, description: "What to hand off" }
        required: ["agent", "message"]

    create_document_access_tool:
      id: "create_document_access_tool"
      name: "Create Document Access"
      category: "utility"
      input_schema:
        type: "object"
        properties:
          doc_name: { type: "string", required: true, description: "Name of document" }
          access_to: { type: "string", required: true, description: "Who to share with" }
          content: { type: "string", required: true, description: "Content of the document" }
        required: ["doc_name", "access_to", "content"]

    edit_document_tool:
      id: "edit_document_tool"
      name: "Edit Document"
      category: "utility"
      input_schema:
        type: "object"
        properties:
          doc_url: { type: "string", required: true, description: "URL of document" }
          text_to_delete: { type: "string", required: true, description: "Text to delete" }
          text_to_replace: { type: "string", required: true, description: "Text to replace the deleted text" }
        required: ["doc_url", "text_to_delete", "text_to_replace"]

    look_for_document_tool:
      id: "look_for_document_tool"
      name: "Look for Document"
      category: "utility"
      input_schema:
        type: "object"
        properties:
          proposed_id: { type: "string", required: true, description: "URL of document to be read" }
        required: ["proposed_id"]

capability_tool_mapping:
  mapping_key_source: "$ref: LOGIC_07_CAPABILITIES#capability_catalog.capabilities"
  fields:
    preferred_tool: "Primary tool to use (tool ID)"
    fallbacks: "Ordered fallback tools"
  mappings:
    rac_query: { preferred_tool: "query_rac", fallbacks: [] }
    market_research: { preferred_tool: "tool_search_web", fallbacks: ["vector_search"] }
    audience_research: { preferred_tool: "tool_search_web", fallbacks: ["vector_search"] }
    competitive_research: { preferred_tool: "tool_search_web", fallbacks: ["vector_search"] }
    image_generation: { preferred_tool: "TOOL_IMAGE_NANO_BANANA", fallbacks: [] }
    capability.image_generation.render: { preferred_tool: "TOOL_IMAGE_NANO_BANANA", fallbacks: [] }

resilience_patterns:
  retry:
    default_config:
      max_attempts: 3
      initial_delay_ms: 1000
      max_delay_ms: 10000
      backoff_multiplier: 2.0
      jitter: true
    retry_conditions:
      retryable: ["timeout", "rate_limit", "server_error_5xx", "connection_reset"]
      not_retryable: ["client_error_4xx", "auth_failure", "invalid_input", "not_found"]
    backoff_strategies:
      exponential:
        formula: "min(initial_delay * (multiplier ^ attempt) + jitter, max_delay)"
      linear:
        formula: "min(initial_delay * attempt, max_delay)"
      constant:
        formula: "initial_delay"

  circuit_breaker:
    default_config:
      failure_threshold: 5
      success_threshold: 2
      timeout_ms: 60000
      half_open_max_calls: 3
    states:
      closed:
        transition: "Open after failure_threshold consecutive failures"
      open:
        transition: "Half-Open after timeout_ms"
        behavior: "Return cached response or fallback"
      half_open:
        transition: "Closed after success_threshold successes, Open after any failure"
        behavior: "Allow half_open_max_calls to test"
    metrics:
      track: ["failure_count", "success_count", "last_failure_time", "state_transitions"]

  fallback:
    strategies:
      cached_response: { applicable_when: "Cache available and not stale", staleness_threshold_minutes: 60 }
      alternative_tool: { applicable_when: "Fallback tool configured" }
      degraded_response: { applicable_when: "Partial data available" }
      graceful_error: { applicable_when: "No other fallback available", template: "Service temporarily unavailable. {context}" }
    selection_order: [1, "cached_response", 2, "alternative_tool", 3, "degraded_response", 4, "graceful_error"]

timeout_configuration:
  defaults:
    simple_tool_ms: 5000
    search_tool_ms: 10000
    data_tool_ms: 30000
    generation_tool_ms: 60000
    integration_tool_ms: 30000
  overrides:
    source: "tool_schema.timeout_ms"
  cascade_timeout:
    enabled: true
    budget_ms: 120000
    behavior: "Cancel remaining tools when budget exhausted"

rate_limiting:
  global_limits:
    requests_per_minute: 1000
    requests_per_hour: 50000
    concurrent_requests: 100
  per_tool_limits:
    source: "tool_schema.rate_limit"
  per_client_limits:
    source: "CLIENT.limits.api_calls"
  rate_limit_response:
    status: 429
    headers: { retry_after: "seconds until reset", x_rate_limit_remaining: "calls remaining" }
    behavior: "Queue and retry with backoff"

error_envelope:
  schema:
    error:
      code: { type: "string" }
      message: { type: "string" }
      category: { type: "enum", values: ["validation", "auth", "rate_limit", "timeout", "server", "unknown"] }
      retryable: { type: "boolean" }
      retry_after_ms: { type: "integer" }
      context: { type: "object" }
  error_codes:
    TOOL_VALIDATION_ERROR: "Invalid tool input"
    TOOL_AUTH_ERROR: "Authentication failed"
    TOOL_RATE_LIMIT: "Rate limit exceeded"
    TOOL_TIMEOUT: "Tool call timed out"
    TOOL_SERVER_ERROR: "Tool server error"
    TOOL_NOT_FOUND: "Tool not found"
    TOOL_UNAVAILABLE: "Tool temporarily unavailable"
    TOOL_CIRCUIT_OPEN: "Circuit breaker open"

tool_logging:
  required_fields: ["correlation_id", "tool_id", "timestamp", "duration_ms", "status"]
  optional_fields: ["input_hash", "output_size", "retry_count", "error_code"]
  metrics:
    - name: "tool_call_duration"
      type: "histogram"
      labels: ["tool_id", "status"]
    - name: "tool_call_count"
      type: "counter"
      labels: ["tool_id", "status"]
    - name: "tool_error_count"
      type: "counter"
      labels: ["tool_id", "error_code"]
    - name: "circuit_breaker_state"
      type: "gauge"
      labels: ["tool_id", "state"]
