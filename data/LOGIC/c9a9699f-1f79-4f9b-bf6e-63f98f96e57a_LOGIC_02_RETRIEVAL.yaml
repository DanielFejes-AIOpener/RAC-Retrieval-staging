# LOGIC_02_RETRIEVAL.yaml -- Retrieval & Override Rules (SSOT)

meta:
  id: "LOGIC_02_RETRIEVAL"
  type: "logic_rules"
  title: "Retrieval & Override Rules"
  owner: "AI Opener"
  status: "active"
  version: "2.0.0"
  last_updated: "2025-12-23"
  notes: "v2.0 - Complete layer degradation templates for all 11 layers"
  tags: [logic, retrieval, override, ssot]

base_dependencies_template:
  schema:
    dependencies:
      type: "array"
      items:
        type: "object"
        required: ["$ref"]
        properties:
          $ref:
            type: "string"

override_rules:
  evaluation_order:
    - CONFIG
    - DEMO
    - LOGIC
    - OPS
    - ROLES
    - PACKS
    - LIBRARIES
    - USE_CASES
    - WORKFLOWS
    - ORG
    - CLIENT

  strategies:
    last_wins:
      behavior: "replace"
    additive_merge:
      behavior: "append"
      applies_to:
        - "quality_gates.entry"
        - "quality_gates.exit"
        - "constraints.requires_approval_for"
    merge_maps:
      behavior: "deep_merge"
      conflict_resolution: "last_wins"
    most_restrictive_wins:
      behavior: "restrictive_merge"
      applies_to:
        - "security_constraints"
        - "blocked_domains"
        - "ai_policy"
      note: "Precedence: CLIENT > ORG > LOGIC_12_GOVERNANCE.minimums"
    immutable:
      behavior: "reject_override"
      applies_to: "$ref: #override_rules.immutable_paths"

  immutable_paths:
    paths:
      - "LOGIC_12_GOVERNANCE.minimums"
      - "LOGIC_09_INTERFACE.output_standards.accessibility"
      - "LOGIC_09_INTERFACE.output_standards.dei_requirements"
      - "LOGIC_09_INTERFACE.hitl_triggers.human_required"
      - "LOGIC_08_QUALITY_GATES.evidence_tiers"
      - "LOGIC_08_QUALITY_GATES.universal_gates"

  exceptions:
    evidence_precedence:
      rule: "ORG/PACK evidence takes precedence over CLIENT evidence for verified benchmarks"
      scope: "Only applies to benchmark-type claims"
    use_case_registry_conflict:
      rule: "CLIENT custom USE_CASE wins (last-wins applies)"
      behavior: "CLIENT.use_cases.custom overrides ORG.use_case_registry.custom for matching IDs"

  tool_mapping_override:
    precedence: "CLIENT overrides ORG overrides LOGIC_10_TOOLS_CORE defaults"
    patch_shape:
      patch:
        mappings:
          type: "map"
          key: "capability_key"
          value:
            allowed_fields: ["preferred_tool", "fallbacks", "constraints"]
            required_fields: ["preferred_tool"]
    validation:
      must_reference_existing_tools: true
      enforce_tightening_only: true

libraries_mechanics:
  eligibility:
    rules:
      - "Library manifest ownership must match runtime org scope"
      - "Library must be explicitly allowlisted via ORG/CLIENT pointers"
      - "Deny by default if no effective allowlist exists"
  allowlist_precedence:
    order: ["CLIENT.libraries.allowlist", "ORG.libraries.allowlist"]
    rules:
      - rule: "If CLIENT allowlist present, it becomes effective allowlist"
      - rule: "Else if ORG allowlist present, it becomes effective allowlist"
      - rule: "Else: effective allowlist is empty (deny by default)"
  runtime_scoping:
    org_scope:
      required: true
      rule: "Any library retrieval MUST include org_id == runtime.org_id"
    client_scope:
      conditional: true
      rule: "If library has client_id, retrieval MUST include client_id == runtime.client_id"
    cross_org:
      prohibited: true
      rule: "Block retrieval and capture policy event if org_id mismatch"

layer_degradation_templates:
  demo:
    if_demo_mode_missing:
      severity: "warning"
      action: "Default to demo_mode: false"
    if_client_file_missing:
      severity: "error"
      action: "Block demo start"
    if_mock_data_missing:
      severity: "warning"
      action: "Disable that simulation, continue with others"
    if_presenter_name_missing:
      severity: "warning"
      action: "Use default: 'Presenter'"

  config:
    if_config_missing:
      severity: "critical"
      action: "Abort startup"
    if_client_has_placeholders:
      severity: "error"
      action: "Block client context activation"
      fallback: "Continue with ORG defaults only"
    if_ref_validation_fails:
      severity: "error"
      action: "Block startup if critical ref, warn if optional"

  logic:
    if_logic_file_missing:
      severity: "critical (startup) | error (on-demand)"
      action: "Startup-critical files abort startup; on-demand files log error"
    if_ssot_section_missing:
      severity: "critical"
      action: "Abort startup"
    if_version_mismatch:
      severity: "error"
      action: "Block if major version mismatch"

  ops:
    if_playbook_missing:
      severity: "warning"
      action: "Use OPS_00_STANDARDS defaults"
    if_voice_undefined:
      severity: "warning"
      action: "Use default professional voice"
    if_handoff_schema_missing:
      severity: "error"
      action: "Block phase transition"

  roles:
    if_role_missing:
      severity: "error"
      action: "Route to alternative role with capability"
    if_capability_unavailable:
      severity: "warning"
      action: "Check alternative role, escalate to orchestrator"
    if_token_budget_exceeded:
      severity: "warning"
      action: "Truncate response, note truncation"

  packs:
    if_pack_missing:
      severity: "warning"
      action: "Proceed without pack knowledge"
    if_evidence_expired:
      severity: "warning"
      action: "Include evidence with freshness warning"
    if_evidence_below_tier:
      severity: "error"
      action: "Block claim or add prominent disclaimer"

  libraries:
    if_no_eligible_libraries:
      severity: "info"
      action: "Proceed without LIBRARIES context; produce gap report"
    if_library_scope_violation:
      severity: "error"
      action: "Block retrieval and capture policy event"
      enforcement: "$ref: LOGIC_16_POLICY_CAPTURE#enforcement_actions"
    if_library_not_allowlisted:
      severity: "error"
      action: "Block retrieval and capture policy event"

  use_cases:
    if_use_case_missing:
      severity: "error"
      action: "Route to ROLE_01_ORCHESTRATOR"
    if_role_unavailable:
      severity: "error"
      action: "Block use case activation"
    if_ai_policy_blocks_use_case:
      severity: "error"
      action: "Block USE_CASE activation"
      enforcement: "$ref: LOGIC_16_POLICY_CAPTURE#enforcement_actions"

  workflows:
    if_workflow_missing:
      severity: "error"
      action: "Route to ROLE_01_ORCHESTRATOR"
    if_phase_entry_blocked:
      severity: "warning"
      action: "Queue phase, notify user"
    if_handoff_rejected:
      severity: "warning"
      action: "Return to previous phase exit gate"
    if_rollback_fails:
      severity: "critical"
      action: "Pause workflow, escalate to human"

  org:
    if_org_identity_missing:
      severity: "error"
      action: "Block startup"
    if_org_config_missing:
      severity: "warning"
      action: "Use RAC defaults"
    if_ai_policy_missing:
      severity: "info"
      action: "Use LOGIC_12 ai_policy defaults"

  client:
    if_client_missing:
      severity: "warning"
      action: "Proceed with ORG context only"
    if_client_has_placeholders:
      severity: "error"
      action: "Block CLIENT activation"
    if_brand_incomplete:
      severity: "warning"
      action: "Use ORG voice defaults"
    if_ai_policy_less_restrictive:
      severity: "warning"
      action: "Enforce ORG ai_policy, log attempted relaxation"

graceful_degradation_patterns:
  severity_levels:
    info:
      action: "log and continue"
    warning:
      action: "log, alert, continue with degraded functionality"
    error:
      action: "log, alert, attempt recovery or fallback"
    critical:
      action: "log, alert, halt operation, require human intervention"
  patterns:
    retry_with_backoff:
      max_attempts: 3
      initial_delay_ms: 1000
      backoff_multiplier: 2.0
    fallback_to_cached:
      max_age_minutes: 60
    degraded_mode:
      log_level: "warning"

version_management:
  rules:
    - "Changes to override_rules require version bump"
    - "Immutable paths may only grow without major version bump"
    - "Tool routing override schema must remain backward compatible"

common_validation_checklist:
  must_pass:
    - "All $ref must resolve"
    - "No override may modify immutable paths"
    - "most_restrictive_wins applies only to specified paths"
    - "tool_mapping_override must not introduce undefined tool IDs"
